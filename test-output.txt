
> medicamenta.me-back-functions@1.0.0 test
> jest src/__tests__/index-cloud-functions.test.ts --no-coverage

  console.log
    Γ£à Jest Setup: Firebase Admin inicializado com emulators

      at Object.<anonymous> (src/__tests__/setup.ts:40:9)

  console.log
       - Firestore Emulator: localhost:8080

      at Object.<anonymous> (src/__tests__/setup.ts:41:9)

  console.log
       - Project ID: test-project

      at Object.<anonymous> (src/__tests__/setup.ts:42:9)

node.exe : (node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
No linha:1 caractere:1
+ & "C:\Program Files\nodejs/node.exe" "C:\Users\Gabriel\AppData\Roamin ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: ((node:21492) Me... code = UNKNOWN:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
(Use `node --trace-warnings ...` to show where the warning was created)
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(node:21492) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
FAIL src/__tests__/index-cloud-functions.test.ts (8.515 s)
  ≡ƒöº Stripe Cloud Functions (src/index.ts)
    Γ£à createStripeCheckoutSession - Positive Scenarios
      ├ù deve criar checkout session com sucesso (cen├írio completo) (2088 ms)
      ├ù deve usar customer existente se j├í cadastrado (31 ms)
      ├ù deve usar trialPeriodDays customizado (15 ms)
      ├ù deve usar trialPeriodDays padr├úo (7) se n├úo especificado (10 ms)
    Γ¥î createStripeCheckoutSession - Error Handling
      ├ù deve capturar e logar erro do Stripe API (16 ms)
      ├ù deve capturar erro ao criar customer (7 ms)
      ├ù deve capturar erro do Firestore ao atualizar documento (9 ms)
    Γ£à createStripeBillingPortalSession - Positive Scenarios
      ├ù deve criar billing portal session com sucesso (11 ms)
    Γ¥î createStripeBillingPortalSession - Error Handling
      ├ù deve lan├ºar erro se customer n├úo encontrado (18 ms)
      ├ù deve capturar erro do Stripe API (10 ms)
    ≡ƒîÉ handleStripeWebhook - HTTP Endpoint
      ├ù deve verificar assinatura e processar evento com sucesso (6 ms)
      ├ù deve retornar 400 se assinatura inv├ílida (11 ms)
      ├ù deve processar evento customer.subscription.created (6 ms)
      ├ù deve processar evento customer.subscription.updated (8 ms)
      ├ù deve processar evento customer.subscription.deleted (8 ms)
      ├ù deve processar evento invoice.payment_succeeded (14 ms)
      ├ù deve processar evento invoice.payment_failed (8 ms)
      ├ù deve ignorar evento n├úo tratado (8 ms)
      ├ù deve retornar 500 se erro ao processar evento (9 ms)
    ΓÜá∩╕Å Webhook Handlers - Edge Cases
      ├ù handleCheckoutSessionCompleted: deve retornar early se sem firebaseUid (8 ms)
      ├ù handleSubscriptionUpdate: deve retornar early se sem firebaseUid (36 ms)
      ├ù handleSubscriptionDeleted: deve retornar early se sem firebaseUid (14 ms)
      ├ù handleInvoicePaymentSucceeded: deve retornar early se customer n├úo encontrado (30 ms)
      ├ù handleInvoicePaymentFailed: deve retornar early se customer n├úo encontrado (12 ms)
      ├ù handleSubscriptionUpdate: deve mapear status "trialing" (9 ms)
      ├ù handleSubscriptionUpdate: deve mapear status diferente de "active"/"trialing" para "canceled" (9 ms)
      ├ù handleCheckoutSessionCompleted: deve mapear status "trialing" corretamente (6 ms)
      ├ù handleCheckoutSessionCompleted: deve mapear status "active" corretamente (11 ms)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ£à createStripeCheckoutSession - Positive Scenarios ΓÇ║ deve criar checkout session com sucesso 
(cen├írio completo)

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:160:47)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ£à createStripeCheckoutSession - Positive Scenarios ΓÇ║ deve usar customer existente se j├í 
cadastrado

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:224:47)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ£à createStripeCheckoutSession - Positive Scenarios ΓÇ║ deve usar trialPeriodDays customizado

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:266:47)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ£à createStripeCheckoutSession - Positive Scenarios ΓÇ║ deve usar trialPeriodDays padr├úo (7) se 
n├úo especificado

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:306:47)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ¥î createStripeCheckoutSession - Error Handling ΓÇ║ deve capturar e logar erro do Stripe API

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:346:47)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ¥î createStripeCheckoutSession - Error Handling ΓÇ║ deve capturar erro ao criar customer

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:388:47)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ¥î createStripeCheckoutSession - Error Handling ΓÇ║ deve capturar erro do Firestore ao atualizar 
documento

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:432:47)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ£à createStripeBillingPortalSession - Positive Scenarios ΓÇ║ deve criar billing portal session com 
sucesso

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:471:52)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ¥î createStripeBillingPortalSession - Error Handling ΓÇ║ deve lan├ºar erro se customer n├úo 
encontrado

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:512:52)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ Γ¥î createStripeBillingPortalSession - Error Handling ΓÇ║ deve capturar erro do Stripe API

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:551:52)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ≡ƒîÉ handleStripeWebhook - HTTP Endpoint ΓÇ║ deve verificar assinatura e processar evento com sucesso

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:606:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ≡ƒîÉ handleStripeWebhook - HTTP Endpoint ΓÇ║ deve retornar 400 se assinatura inv├ílida

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:640:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ≡ƒîÉ handleStripeWebhook - HTTP Endpoint ΓÇ║ deve processar evento customer.subscription.created

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:684:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ≡ƒîÉ handleStripeWebhook - HTTP Endpoint ΓÇ║ deve processar evento customer.subscription.updated

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:722:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ≡ƒîÉ handleStripeWebhook - HTTP Endpoint ΓÇ║ deve processar evento customer.subscription.deleted

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:769:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ≡ƒîÉ handleStripeWebhook - HTTP Endpoint ΓÇ║ deve processar evento invoice.payment_succeeded

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:832:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ≡ƒîÉ handleStripeWebhook - HTTP Endpoint ΓÇ║ deve processar evento invoice.payment_failed

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:890:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ≡ƒîÉ handleStripeWebhook - HTTP Endpoint ΓÇ║ deve ignorar evento n├úo tratado

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:919:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ≡ƒîÉ handleStripeWebhook - HTTP Endpoint ΓÇ║ deve retornar 500 se erro ao processar evento

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:960:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ΓÜá∩╕Å Webhook Handlers - Edge Cases ΓÇ║ handleCheckoutSessionCompleted: deve retornar early se sem 
firebaseUid

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:1001:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ΓÜá∩╕Å Webhook Handlers - Edge Cases ΓÇ║ handleSubscriptionUpdate: deve retornar early se sem 
firebaseUid

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:1037:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ΓÜá∩╕Å Webhook Handlers - Edge Cases ΓÇ║ handleSubscriptionDeleted: deve retornar early se sem 
firebaseUid

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:1069:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ΓÜá∩╕Å Webhook Handlers - Edge Cases ΓÇ║ handleInvoicePaymentSucceeded: deve retornar early se 
customer n├úo encontrado

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:1108:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ΓÜá∩╕Å Webhook Handlers - Edge Cases ΓÇ║ handleInvoicePaymentFailed: deve retornar early se customer 
n├úo encontrado

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:1147:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ΓÜá∩╕Å Webhook Handlers - Edge Cases ΓÇ║ handleSubscriptionUpdate: deve mapear status "trialing"

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:1188:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ΓÜá∩╕Å Webhook Handlers - Edge Cases ΓÇ║ handleSubscriptionUpdate: deve mapear status diferente de 
"active"/"trialing" para "canceled"

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:1232:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ΓÜá∩╕Å Webhook Handlers - Edge Cases ΓÇ║ handleCheckoutSessionCompleted: deve mapear status 
"trialing" corretamente

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:1282:39)

  ΓùÅ ≡ƒöº Stripe Cloud Functions (src/index.ts) ΓÇ║ ΓÜá∩╕Å Webhook Handlers - Edge Cases ΓÇ║ handleCheckoutSessionCompleted: deve mapear status "active" 
corretamente

    TypeError: functions.region is not a function

    [0m [90m 44 |[39m [90m */[39m
     [90m 45 |[39m [36mexport[39m [36mconst[39m processImageWithCloudVision [33m=[39m functions
    [31m[1m>[22m[39m[90m 46 |[39m   [33m.[39mregion([32m'us-central1'[39m)
     [90m    |[39m    [31m[1m^[22m[39m
     [90m 47 |[39m   [33m.[39mrunWith({
     [90m 48 |[39m     timeoutSeconds[33m:[39m [35m60[39m[33m,[39m
     [90m 49 |[39m     memory[33m:[39m [32m'512MB'[39m[0m

      at Object.<anonymous> (src/ocr-cloud-vision.ts:46:4)
      at Object.<anonymous> (src/index.ts:19:1)
      at Object.<anonymous> (src/__tests__/index-cloud-functions.test.ts:1333:39)

Test Suites: 1 failed, 1 total
Tests:       28 failed, 28 total
Snapshots:   0 total
Time:        9.188 s
Ran all test suites matching src/__tests__/index-cloud-functions.test.ts.
